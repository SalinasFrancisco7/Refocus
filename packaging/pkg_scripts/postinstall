#!/bin/bash
set -euo pipefail

LOG_FILE="/tmp/refocus_postinstall.log"
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

APP_PATH="/Applications/Refocus.app"
HOST_BINARY="$APP_PATH/Contents/Helpers/refocus_native_host"
MANIFEST_DIR="/Library/Google/Chrome/NativeMessagingHosts"
MANIFEST_PATH="$MANIFEST_DIR/com.refocus.native_host.json"

log "Starting Refocus postinstall..."

if [[ ! -x "$HOST_BINARY" ]]; then
    log "Warning: Native host not executable at $HOST_BINARY"
    chmod +x "$HOST_BINARY" 2>/dev/null || log "Failed to make native host executable"
fi

if [[ ! -f "$HOST_BINARY" ]]; then
    log "Error: Native host binary not found at $HOST_BINARY"
    exit 1
fi

log "Creating native messaging host manifest..."
mkdir -p "$MANIFEST_DIR"
cat > "$MANIFEST_PATH" <<EOF
{
  "name": "com.refocus.native_host",
  "description": "Refocus native bridge between Chrome and the macOS enforcer",
  "path": "$HOST_BINARY",
  "type": "stdio",
  "allowed_origins": [
    "chrome-extension://ggkajgncinmdnpdpoplgaakbfedgbadm/"
  ]
}
EOF
chmod 644 "$MANIFEST_PATH"
chown root:wheel "$MANIFEST_PATH"

log "Native messaging host manifest installed at $MANIFEST_PATH"
log "Refocus postinstall completed successfully"
exit 0
